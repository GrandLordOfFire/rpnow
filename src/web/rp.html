<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Loading RP | RPNow</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#fafafa">

  <link rel="icon" type="image/png" href="/client-files/assets/favicon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/client-files/assets/favicon/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/client-files/assets/favicon/favicon-96x96.png" sizes="96x96">
  <link rel="apple-touch-icon" href="/client-files/assets/favicon/favicon-128x128.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alice|Playfair+Display">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="manifest" href="/client-files/manifest.json">

  <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
  <!-- <link rel="stylesheet" href="/client-files/room.css"> -->
</head>
<body>
  <div id="rp-chat" class="app-container">
    <v-app>
      <div id="loading" v-if="rp == null">
        <i class="material-icons">hourglass_full</i>
        Loading...
      </div>

      <template v-if="rp != null">
        <v-toolbar app flat>
          <v-toolbar-side-icon @click.stop="mainMenuOpen = !mainMenuOpen"></v-toolbar-side-icon>
          <v-spacer></v-spacer>
          <v-toolbar-title>{{ rp.title }}</v-toolbar-title>
          <v-spacer></v-spacer>
        </v-toolbar>

        <v-navigation-drawer app floating temporary v-model="mainMenuOpen">
          <v-toolbar flat>
            <v-toolbar-title>RPNow</v-toolbar-title>
          </v-toolbar>
          <v-divider></v-divider>
        </v-navigation-drawer>

        <v-content>
        <!-- <header>
          <h2>{{ rp.title }}</h2>
          <p>{{ rp.desc }}</p>
          <div id="title-links" v-if="!demo">
            <a :href="'/rp/'+rpCode">Home</a> |
            <a :href="'/rp/'+rpCode+'/1'">Archive</a> |
            <a href="/">New RP</a>
          </div>
        </header> -->

        <div id="messages" class="room-feed">
          <div class="info-box" v-if="rp.msgs.length >= 60">
            <p>These are the latest 60 posts.
            To view earlier messages, check the <a href="./1">archive</a>.</p>
          </div>

          <div class="info-box" v-if="isNewRp">
            <p><b>Success!</b></p>
            <p>The RP {{ rp.title }} has been created. Just share this link with some friends, and you can all start roleplaying together, in real time!</p>
            <a :href="linkToHere">{{ linkToHere }}</a>
            <p>Please keep the following things in mind, however:</p>
            <ol>
              <li><b>Don't lose the link to this room!</b> If you can't find it, you won't be able to find this room again!</li>
              <li>Anyone with a link to this room can play here. <b>Be careful who you share it with!</b></li>
              <li><b>Don't post any sensitive information here!</b> In the event of a database breach, we would not want anything confidential to be lost.</li>
              <li>RPNow is currently under development, so there's a small chance your stories could be unexpectedly lost &mdash; so, just in case, you can download a copy of the entire RP by clicking the <b>Export</b> link up top.</li>
            </ol>
            <p>Have fun!</p>
          </div>

          <template v-for="msg of rp.msgs">
            <rp-message
              :key="msg._id"
              :type="msg.type"
              :content="msg.content"
              :url="msg.url"
              :timestamp="msg.timestamp"
              :revision="msg.revision"
              :ipid="msg.ip"
              :chara="charasById[msg.charaId]"
              :can-edit="true"
              :press-enter-to-send="true"
              :show-message-details="true"
            ></rp-message>
          </template>
        </div>
      
        <div id="character-menu" v-show="showCharacterMenu">
          <h3>Characters</h3>
          <ul id="special-characters">
            <li id="narrator-button">
              <a href="#" @click.prevent="selectCharacter('narrator')">Narrator</a>
            </li>
            <li id="ooc-button">
              <a href="#" @click.prevent="selectCharacter('ooc')">Out of Character</a>
            </li>
          </ul>
          <ul id="normal-characters">
            <li v-for="chara of rp.charas" key="chara._id">
              <a href="#" @click.prevent="selectCharacter('chara', chara._id)" :style="{'background-color':chara.color}">{{ chara.name }}</a>
            </li>
          </ul>
          <button type="button" id="new-character-button" @click="openCharacterDialog">New Character...</button>
        </div>
      
        <form id="new-character" class="form-box" autocomplete="off" v-show="showCharacterDialog">
          <h3>New Character</h3>
          <div class="input-section">
            <div class="input-name">Name</div>
            <div class="input-container"><input type="text" name="name" maxlength="30" v-model="charaDialogName"></div>
          </div>
          <div class="input-section">
            <div class="input-name">Color</div>
            <div class="input-container"><input type="color" name="color" v-model="charaDialogColor"></div>
          </div>
          <button type="button" @click="sendChara">Add</button>
          <button type="button" @click="closeCharacterDialog">Cancel</button>
        </form>
      
        <div id="message-box" :class="messageBoxClass" :style="messageBoxStyle" autocomplete="off" v-show="!showCharacterMenu">
          <div id="format-bar">
            <div id="message-voice">{{ currentVoiceName }}</div>
            <button type="button" id="change-character" class="btn-margin" @click="openCharacterMenu"><span>Change...</span></button>
            <a id="show-format-guide" class="btn-margin" href="/format" target="_blank"><span>?</span></a>
          </div>
          <div id="message-bar">
            <div id="message-text">
              <textarea v-model="msgBoxText" @keydown.enter.prevent="sendMessage"></textarea>
            </div>
            <div id="message-button-container">
              <button type="button" id="send-button" @click="sendMessage">Send</button>
            </div>
          </div>
        </div>
        </v-content>
      </v-app>

      <div class="overlay" v-show="showOverlay"></div>
    </template>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/babel-polyfill@6.26.0/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/http-vue-loader@1.3.5/src/httpVueLoader.js"></script>
  <script>
    new Vue({
      el: '#rp-chat',
      components: {
        'rp-message': httpVueLoader('/client-files/rp-message.vue'),
      },
      data: {
        demo: false,
        linkToHere: location.href,
        rpCode: location.pathname.match(/\/rp\/([^\/]+)/)[1],
        rp: null,
        isNewRp: false,
        msgBoxText: '',
        currentMsgType: 'narrator',
        currentCharaId: null,
        charaDialogName: '',
        charaDialogColor: '#dddddd',
        showCharacterMenu: false,
        showCharacterDialog: false,
        mainMenuOpen: false,
      },
      computed: {
        charasById: function() {
          return this.rp.charas.reduce(function(map, chara) {
            map[chara._id] = chara;
            return map;
          }, {});
        },
        currentChara: function() {
          if (this.currentMsgType !== 'chara') return undefined;
          return this.charasById[this.currentCharaId]
        },
        currentVoiceName: function() {
          if (this.currentMsgType === 'narrator') return 'Narrator';
          if (this.currentMsgType === 'ooc') return 'Out of Character';
          return this.currentChara.name;
        },
        currentCharaColor: function() {
          if (this.currentMsgType !== 'chara') return undefined;
          return this.currentChara.color;
        },
        messageBoxClass: function() {
          return 'message-box-' + this.currentMsgType;
        },
        messageBoxStyle: function() {
          if (this.currentMsgType !== 'chara') return {};
          else return { 'background-color': this.currentCharaColor };
        },
        showOverlay: function() {
          return this.showCharacterDialog;
        },
      },
      methods: {
        fetchUpdates: function() {
          var scheduleNextUpdate = (function() {
            setTimeout(this.fetchUpdates.bind(this), 5000);
          }).bind(this);

          axios.get('/api/rp/' + this.rpCode + '/updates?since=' + this.rp.lastEventId)
            .then((function(res) {
              this.rp.lastEventId = res.data.lastEventId;

              res.data.updates.forEach((function(update) {
                this.updateState(update);
              }).bind(this));

              scheduleNextUpdate();
            }).bind(this))
            .catch((function(err) {
              console.error(err);
              scheduleNextUpdate();
            }).bind(this))
        },
        updateState: function(update) {
          var arr = this.rp[update.type];

          arr = arr.filter(function(item) { return item._id !== update.data._id });
          arr.push(update.data);
          arr.sort(function(a, b) { return a._id < b._id ? -1 : 1 });

          // keep no more than 60 messages
          if (update.type === 'msgs') {
            arr = arr.slice(-60);
          }

          this.rp[update.type] = arr;
        },
        sendMessage: function() {
          var data = {
            content: this.msgBoxText,
            type: this.currentMsgType,
            charaId: this.currentCharaId || undefined,
          };
          axios.post('/api/rp/' + this.rpCode + '/msgs', data)
            .then((function() {
              this.msgBoxText = '';
            }).bind(this));
        },
        sendChara: function() {
          var data = {
            name: this.charaDialogName,
            color: this.charaDialogColor,
          };
          axios.post('/api/rp/' + this.rpCode + '/charas', data)
            .then((function(res) {
              this.charaDialogName = '';
              this.showCharacterDialog = false;
              this.selectCharacter('chara', res.data._id);
            }).bind(this));
        },
        openCharacterMenu: function() {
          this.showCharacterMenu = true;
        },
        openCharacterDialog: function() {
          this.showCharacterDialog = true;
        },
        closeCharacterDialog: function() {
          this.showCharacterDialog = false;
        },
        selectCharacter: function(type, charaId) {
          this.currentMsgType = type;
          this.currentCharaId = (type === 'chara') ? charaId : null;
          this.showCharacterMenu = false;
        }
      },
      created: function() {
        axios.get('/api/rp/' + this.rpCode)
          .then((function(res) {
            this.rp = res.data;

            document.title = this.rp.title + ' | RPNow';
            this.isNewRp = this.rp.msgs.length === 0;

            this.fetchUpdates();
          }).bind(this));
      },
    })
  </script>
</body>
</html>

