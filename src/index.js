#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const os = require('os');
const GreenlockExpress = require('greenlock-express')
const nconf = require('nconf');
const camelcase = require('camelcase');
const ini = require('ini');
const DB = require('./services/database');
const { isAlreadyRunning, notifyRunning } = require('./services/is-already-running');
const bannerMessage = require('./services/cli-banner-message');
const httpsPrompts = require('./services/https-prompts');
const app = require('./app');

// get app configuration
const config = nconf
    .argv({
        parseValues: true,
    })
    .env({
        transform({ key, value }) {
            if (!/^RPNOW_/.test(key)) return false;
            return {
                key: camelcase(obj.key.substr('RPNOW_'.length)),
                value
            };
        },
        parseValues: true,
    })
    .add('default configPath', {
        type: 'literal',
        store: {
            configPath: (process.pkg) ?
                path.join(path.dirname(process.argv[0], 'rpnow.ini')) :
                path.join(path.dirname(process.argv[1]), '..', 'rpnow.ini')
        }
    })
    .file('rpnow.ini config file', {
        file: nconf.get('configPath'),
        format: {
            parse: str => {
                const obj = ini.parse(str);
                Object.entries(obj).forEach(([key, value]) => {
                    try { obj[key] = JSON.parse(value) } catch (_) {}
                });
                return obj;
            }
        },
    })
    .add('default dataDir', {
        type: 'literal',
        store: {
            dataDir: process.platform === 'win32' ?
                path.join(process.env.APPDATA, 'rpnow', 'data') :
                path.join(os.homedir(), 'rpnow')
        }
    })
    .defaults({
        port: 80,
        ssl: false,
        sslPort: 443,
        sslDomain: '',
        letsencryptAgree: false,
        letsencryptEmail: '',
        letsencryptDir: path.join(nconf.get('dataDir'), 'letsencrypt'),
        trustProxy: false,
    })
    .get();

console.log(config);
process.exit(0);






function showError(str) {
    console.error(str);

    if (process.pkg) {
        // In desktop app mode, keep the process alive
        console.error('(Press Ctrl+C to exit.)')
        setInterval(() => {}, 10000); 
    } else {
        // In command line mode, exit with error code
        process.exit(1);
    }
}

(async function main() {
    // if not exists
    if (!fs.existsSync(config.dataDir)){
        // if not interactive, die and tell why
        if (!process.stdin.isTTY) return showError('Cannot find data directory')

        // create directory
        fs.mkdirSync(config.dataDir);
        fs.mkdirSync(config.letsencryptDir);
    }

    // initialize db
    await DB.open(config.dataDir);

    // check if the server is already running (or ports are used)
    if (await isAlreadyRunning(config.dataDir)) {
        return showError('ERROR: RPNow is already running');
    }

    // write lastport.lock
    notifyRunning(config.dataDir, config.sslPort || config.port)

    // enable trustProxy?
    if (config.trustProxy) app.enable('trust proxy');

    // start server
    if (config.ssl) {
        if (!config.letsencryptAgree) return showError("ERROR: You must accept the Let's Encrypt TOS to use this service.");

        const server = GreenlockExpress.create({
            app,

            email: config.letsencryptEmail,
            agreeTos: config.letsencryptAgree,
            approvedDomains: [config.sslDomain],
            configDir: config.letsencryptDir,

            communityMember: false,
            securityUpdates: false,
            telemetry: true,
        });
        server.listen(config.port, config.httpsPort, (err) => {
            if (err) return showError(`ERROR: RPNow failed to start: ${err}`);

            // delay logging this until messages generated by vue-pronto are done
            setTimeout(() => console.log(bannerMessage(config)), 2000);
        });
    } else {
        app.listen(config.port, (err) => {
            if (err) return showError(`ERROR: RPNow failed to start: ${err}`);

            // delay logging this until messages generated by vue-pronto are done
            setTimeout(() => console.log(bannerMessage(config)), 2000);
        });
    }
}());
